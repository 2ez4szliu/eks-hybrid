#cloud-config
{{- if .RootPasswordHash }}
users:
  - name: root
    lock_passwd: false
    hashed_passwd: {{ .RootPasswordHash }}
{{- end }}
package_update: true
write_files:
  - content: |
{{ .NodeadmConfig | indent 6 }}
    path: nodeadm-config.yaml
{{ range $file := .Files }}
  - content: |
{{ $file.Content | indent 6 }}
    path: {{ $file.Path }}
{{- end }}
runcmd:
  - echo "Downloading nodeadm binary"
  - curl -s --retry 5 -L "{{ .NodeadmUrl }}" -o /tmp/nodeadm
  - chmod +x /tmp/nodeadm
  - echo "Installing kubernetes components"
  - /tmp/nodeadm install {{ .KubernetesVersion }} --credential-provider {{ .Provider }}
  - echo "Initializing the node"
  - /tmp/nodeadm init -c file:///nodeadm-config.yaml

final_message: "The system is prepped, after $UPTIME seconds"
