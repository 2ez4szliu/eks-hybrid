AWSTemplateFormatVersion: '2010-09-09'
Description: CloudFormation template to create IAM roles and an EC2 instance with customizable volume size.

Parameters:
  ssm:
    Type: String
    Description: Specify whether to use the SSM provider.
    AllowedValues: ['true', 'false']
    Default: 'false'
  clusterArn:
    Type: String
    Description: The ARN of the EKS cluster to restrict access.
  clusterName:
    Type: String
    Description: The name of the EKS cluster.

Conditions:
  CreateSSMRole: !Equals [!Ref ssm, 'true']

Resources:
  SSMRole:
    Condition: CreateSSMRole
    Type: AWS::IAM::Role
    Properties: 
      RoleName: !Sub "HybridNodesIAMRoleSSM-${AWS::StackName}"
      AssumeRolePolicyDocument: 
        Version: '2012-10-17'
        Statement: 
          - Effect: Allow
            Principal: 
              Service: ssm.amazonaws.com
            Action: sts:AssumeRole
      Policies: 
        - PolicyName: SSMRolePolicy
          PolicyDocument: 
            Version: '2012-10-17'
            Statement: 
              - Sid: AllowDeregisterAndDescribeOwnInstance
                Effect: Allow
                Action: 
                  - ssm:DeregisterManagedInstance
                  - ssm:DescribeInstanceInformation
                Resource: arn:aws:ec2:*:*:instance/${sts:RoleSessionName}
                Condition:
                  ArnLike:
                    'aws:SourceArn': arn:aws:ec2:*:*:instance/${sts:RoleSessionName}
        - PolicyName: EKSDescribeCluster
          PolicyDocument: 
            Version: '2012-10-17'
            Statement: 
              - Effect: Allow
                Action: 
                  - eks:DescribeCluster
                Resource: !Ref clusterArn
      ManagedPolicyArns: 
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryPullOnly
      Tags: 
        - Key: Name
          Value: !Sub '${AWS::StackName}-ssm-role'

  # Create IAM Role for EC2
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "HybridNodesEC2Role-${AWS::StackName}"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
  # Create Instance Profile for EC2 Role
  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Sub "HybridNodesEC2InstanceProfile-${AWS::StackName}"
      Roles:
        - !Ref EC2Role
  
  ClusterAccessEntry:
    Type: AWS::EKS::AccessEntry
    Properties:
      ClusterName: !Ref clusterName
      PrincipalArn: !GetAtt SSMRole.Arn
      Type: HYBRID_LINUX

Outputs:
  EC2Role:
    Description: The name of the IAM Role for EC2.
    Value: !Ref EC2Role

  EC2InstanceProfile:
    Description: The name of the IAM Role for EC2.
    Value: !Ref EC2InstanceProfile

  SSMNodeRoleName:
    Description: The name of the IAM Role for SSM.
    Value: !Ref SSMRole

  SSMNodeRoleARN:
    Description: The ARN of the IAM Role for SSM.
    Value: !GetAtt SSMRole.Arn
